<div id="spinner" class="text-center my-3" style="display:none;">
    <div class="spinner-border text-primary" role="status"></div>
    <div>Loading... Please wait</div>
</div>

<script>

let pendingRequests = 0; // count how many API calls are running

function showSpinner() {
    document.getElementById("spinner").style.display = "block";
}

function hideSpinner() {
    document.getElementById("spinner").style.display = "none";
}

function processCSV() {
    const file = document.getElementById("csvFile").files[0];
    if (!file) { alert("Please upload CSV"); return; }

    showSpinner();

    const reader = new FileReader();
    reader.onload = function(event) {
        const lines = event.target.result.split("\n");

        lines.forEach(line => {
            if (!line.trim()) return;

            const [hostname, snmpname] = line.split(",");
            pendingRequests++;   // increment per line
            callAllApis(hostname.trim(), snmpname.trim());
        });
    };
    reader.readAsText(file);
}


async function callAllApis(host, snmp) {

    // Call 3 APIs in parallel
    const api1 = fetch("https://your-api1.com/check?host=" + host).then(r => r.json());
    const api2 = fetch("https://your-api2.com/check?host=" + host).then(r => r.json());
    const api3 = fetch("https://your-api3.com/check?host=" + host).then(r => r.json());

    const results = await Promise.all([api1, api2, api3]);

    addRow(host, snmp, results);

    pendingRequests--;

    if (pendingRequests === 0) {
        hideSpinner();   // hide when all API calls finished
    }
}



function addRow(hostname, snmp, results) {
    const table = document.querySelector("#resultTable tbody");

    const row = document.createElement("tr");

    const c1 = results[0];
    const c2 = results[1];
    const c3 = results[2];

    row.innerHTML = `
        <td>${hostname}</td>
        <td>${snmp}</td>

        <td class="${c1.status === 'SUCCESS' ? 'success-cell' : 'fail-cell'}">
            <b>${c1.status}</b><br>
            <small>${c1.comments}</small>
        </td>

        <td class="${c2.status === 'SUCCESS' ? 'success-cell' : 'fail-cell'}">
            <b>${c2.status}</b><br>
            <small>${c2.comments}</small>
        </td>

        <td class="${c3.status === 'SUCCESS' ? 'success-cell' : 'fail-cell'}">
            <b>${c3.status}</b><br>
            <small>${c3.comments}</small>
        </td>
    `;

    table.appendChild(row);
}

</script>